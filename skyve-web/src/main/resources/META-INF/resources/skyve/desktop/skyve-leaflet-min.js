isc.ClassFactory.defineClass("BizMap","Canvas");isc.BizMap.addClassMethods({loadingLeaflet:false,loadLeaflet:function(a){if(isc.BizMap.loadingLeaflet){setTimeout(function(){isc.BizMap.loadLeaflet(a)},100)}else{if(window.L){a()}else{isc.BizMap.loadingLeaflet=true;SKYVE.Util.loadCSS("leaflet/leaflet.css?v="+SKYVE.Util.v,function(){SKYVE.Util.loadJS("leaflet/leaflet.js?v="+SKYVE.Util.v,function(){SKYVE.Util.loadJS("leaflet/Path.Drag.js?v="+SKYVE.Util.v,function(){SKYVE.Util.loadJS("leaflet/Leaflet.Editable.js?v="+SKYVE.Util.v,function(){SKYVE.Util.loadCSS("leaflet/leaflet.fullscreen.css?v="+SKYVE.Util.v,function(){SKYVE.Util.loadJS("leaflet/Leaflet.fullscreen.min.js?v="+SKYVE.Util.v,function(){isc.BizMap.loadingLeaflet=false;a()})})})})})})}}},v:0,initialise:function(){eval(isc.BizMap.id+".build()")}});isc.BizMap.addMethods({init:function(a){this._refreshRequired=true;this._refreshing=false;this._zoomed=false;this.width="100%";this.height="100%";this.styleName="googleMapDivParent",this.ID="bizMap"+isc.BizMap.v++;this.redrawOnResize=false;this.Super("init",arguments);this._objects={};this._intervalId=null},getInnerHTML:function(){return'<div id="'+this.ID+'_map" style="margin:0;padding:0;height:100%">Loading Map...</div>'},draw:function(){if(window.L){if(!this.isDrawn()){this.build();return this.Super("draw",arguments)}}else{isc.BizMap.id=this.ID;isc.BizMap.loadLeaflet(isc.BizMap.initialise);return this.Super("draw",arguments)}},setDataSource:function(b){if(window.L&&this.webmap){if(this._view){this._modelName=b;this._moduleName=null;this._queryName=null;this._geometryBinding=null;var c=this._view._grids[b];if(c){}else{c={};this._view._grids[b]=c}c[this.getID()]=this}else{var a=b.indexOf("_");this._moduleName=b.substring(0,a);this._queryName=b.substring(a+1);a=this._queryName.indexOf("_");this._geometryBinding=this._queryName.substring(a+1);this._queryName=this._queryName.substring(0,a);this._modelName=null}this._refresh(true)}else{this.delayCall("setDataSource",arguments,100)}},build:function(){if(this.isDrawn()){var mapOptions={zoom:1,center:[0,0],fullscreenControl:{pseudoFullscreen:false},layers:eval(SKYVE.Util.mapLayers)};if(this.webmap){mapOptions.zoom=this.webmap.getZoom();mapOptions.center=this.webmap.getCenter()}this._objects={};var element=document.getElementById(this.ID+"_map");element.innerHTML="";this.webmap=L.map(element,mapOptions);if(this.showRefresh){SKYVE.Leaflet.refreshControls(this)}if(this.loading=="lazy"){var me=this;this.webmap.on("zoomend",function(event){if(!me._refreshing){me._refresh(false)}});this.webmap.on("moveend",function(event){me._refresh(false)})}this._refresh(true);if(this._intervalId){clearInterval(this._intervalId);this._intervalId=null}if((this.refreshTime>0)&&this._refreshRequired){this._intervalId=setInterval(this.rerender.bind(this),this.refreshTime*1000)}}else{this.delayCall("build",null,100)}},rerender:function(){this._refresh(false)},resume:function(){this._zoomed=false},_refresh:function(d){if(this._zoomed){return}if(this._refreshing){return}if(!this.isDrawn()){return}if(!this.isVisible()){return}var c=SKYVE.Util.CONTEXT_URL+"map?";if(this._view){if(this._modelName){var b=this._view.gather(false);c+="_c="+b._c+"&_m="+this._modelName}else{return}}else{if(this._queryName){c+="_mod="+this._moduleName+"&_q="+this._queryName+"&_geo="+this._geometryBinding}else{return}}this._refreshing=true;var g="";if(this.loading=="lazy"){if(this.webmap){var f=this.webmap.wrapLatLngBounds(this.webmap.getBounds());if(f){var a=f.getNorthEast();g="&_ne=POINT("+a.lng+" "+a.lat+")";a=f.getSouthWest();g+="&_sw=POINT("+a.lng+" "+a.lat+")"}}}var e=this;isc.RPCManager.sendRequest({showPrompt:true,evalResult:true,actionURL:c+g,httpMethod:"GET",callback:function(j,i,h){try{SKYVE.Leaflet.scatter(e,i,d,true)}finally{e._refreshing=false}}})},click:function(b){var a="";if(b.zoomData){this._selectedLayer=b;var a=b.zoomData.infoMarkup;a+='<br/><br/><input type="button" value="Zoom" onclick="'+this.ID+'.zoom()"/>'}return a},zoom:function(){this._zoomed=true;var b=this.getPageRect();var i=null;var c=null;if(this._selectedLayer.getBounds){var a=this._selectedLayer.getBounds();var d=a.getNorthWest();var e=a.getSouthEast();i=this.webmap.latLngToContainerPoint(d);c=this.webmap.latLngToContainerPoint(e)}else{var g=this._selectedLayer.feature.geometry.coordinates;var h=this.webmap.latLngToContainerPoint(L.latLng(g[1],g[0]));i=L.point(h.x-10,h.y-10);c=L.point(h.x+10,h.y+10)}var f=this;isc.BizUtil.getEditView(this._selectedLayer.zoomData.mod,this._selectedLayer.zoomData.doc,function(j){isc.WindowStack.popup([b[0]+Math.max(i.x,0),b[1]+Math.max(i.y,0),Math.min(c.x-i.x,c.x,b[2]),Math.min(c.y-i.y,c.y,b[3])],"Edit",true,[j]);j.editInstance(f._selectedLayer.zoomData.bizId,null,null);f._selectedLayer.closePopup();f._selectedLayer=null})}});isc.ClassFactory.defineClass("BizMapPicker","HTMLFlow");isc.BizMapPicker.addClassMethods({v:0,initialise:function(){eval(isc.BizMapPicker.id+".build()")}});isc.BizMapPicker.addMethods({init:function(a){this.width="100%";this.height="100%";this.styleName="googleMapDivParent";this.ID="bizMapPicker"+isc.BizMapPicker.v++;this.contents='<div id="'+this.ID+'_map" style="margin:0;padding:0;height:100%">Loading Map...</div>';this.Super("init",arguments);this._overlays=[];this.field=a.field;this.drawingTools=a.drawingTools;if(window.L){this.build()}else{isc.BizMapPicker.id=this.ID;isc.BizMap.loadLeaflet(isc.BizMapPicker.initialise)}},setDisabled:function(a){SKYVE.Leaflet.setDisabled(this,a)},mapIt:function(){var a=this.field.getValue();SKYVE.Leaflet.scatterValue(this,a)},setFieldValue:function(a){this.field.setValueFromPicker(a)},build:function(){if(this.isDrawn()){if(!this.webmap){var mapOptions={zoom:SKYVE.Util.mapZoom,center:SKYVE.Leaflet.centre(),editable:true,fullscreenControl:{pseudoFullscreen:false},layers:eval(SKYVE.Util.mapLayers)};var element=document.getElementById(this.ID+"_map");element.innerHTML="";this.webmap=L.map(element,mapOptions);SKYVE.Leaflet.drawingTools(this);SKYVE.Leaflet.geoLocator(this);SKYVE.Leaflet.setDisabled(this,this.field.isDisabled())}SKYVE.Leaflet.clear(this);this.mapIt()}else{this.delayCall("build",null,100)}}});