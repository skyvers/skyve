isc.ClassFactory.defineClass("BizMap","Canvas");
isc.BizMap.addClassMethods({loadingLeaflet:!1,loadLeaflet:function(a){isc.BizMap.loadingLeaflet?setTimeout(()=>isc.BizMap.loadLeaflet(a),100):window.L?a():(isc.BizMap.loadingLeaflet=!0,SKYVE.Util.loadCSS(`leaflet/leaflet.css?v=${SKYVE.Util.v}`,()=>{SKYVE.Util.loadJS(`leaflet/leaflet.js?v=${SKYVE.Util.v}`,()=>{SKYVE.Util.loadJS(`leaflet/Path.Drag.js?v=${SKYVE.Util.v}`,()=>{SKYVE.Util.loadJS(`leaflet/Leaflet.Editable.js?v=${SKYVE.Util.v}`,()=>{SKYVE.Util.loadCSS(`leaflet/leaflet.fullscreen.css?v=${SKYVE.Util.v}`,()=>
{SKYVE.Util.loadJS(`leaflet/Leaflet.fullscreen.min.js?v=${SKYVE.Util.v}`,()=>{isc.BizMap.loadingLeaflet=!1;a()})})})})})}))},v:0,initialise:function(){eval(`${isc.BizMap.id}.build()`)}});
isc.BizMap.addMethods({init:function(a){this._refreshRequired=!0;this._zoomed=this._refreshing=!1;this.height=this.width="100%";this.styleName="googleMapDivParent";this.ID=`bizMap${isc.BizMap.v++}`;this.redrawOnResize=!1;this.Super("init",arguments);this._objects={};this._intervalId=null},getInnerHTML:function(){return`<div id="${this.ID}_map" style="margin:0;padding:0;height:100%">Loading Map...</div>`},draw:function(){if(window.L){if(!this.isDrawn())return this.build(),this.Super("draw",arguments)}else return isc.BizMap.id=
this.ID,isc.BizMap.loadLeaflet(isc.BizMap.initialise),this.Super("draw",arguments)},setDataSource:function(a){if(window.L&&this.webmap){if(this._view){this._modelName=a;this._geometryBinding=this._queryName=this._moduleName=null;var b=this._view._grids[a]||{};this._view._grids[a]=b;b[this.getID()]=this}else b=a.indexOf("_"),this._moduleName=a.substring(0,b),this._queryName=a.substring(b+1),b=this._queryName.indexOf("_"),this._geometryBinding=this._queryName.substring(b+1),this._queryName=this._queryName.substring(0,
b),this._modelName=null;this._refresh(!0)}else this.delayCall("setDataSource",arguments,100)},build:function(){if(this.isDrawn()){const a={zoom:1,center:[0,0],fullscreenControl:{pseudoFullscreen:!1},layers:eval(SKYVE.Util.mapLayers)};this.webmap&&(a.zoom=this.webmap.getZoom(),a.center=this.webmap.getCenter());this._objects={};const b=document.getElementById(`${this.ID}_map`);b.innerHTML="";this.webmap=L.map(b,a);this.showRefresh&&SKYVE.Leaflet.refreshControls(this);this.loading==="lazy"&&(this.webmap.on("zoomend",
()=>{this._refreshing||this._refresh(!1)}),this.webmap.on("moveend",()=>{this._refresh(!1)}));this._refresh(!0);this._intervalId&&(clearInterval(this._intervalId),this._intervalId=null);this.refreshTime>0&&this._refreshRequired&&(this._intervalId=setInterval(this.rerender.bind(this),this.refreshTime*1E3))}else this.delayCall("build",null,100)},rerender:function(){this._refresh(!1)},resume:function(){this._zoomed=!1},_refresh:function(a){if(!this._zoomed&&!this._refreshing&&this.isDrawn()&&this.isVisible()){var b=
`${SKYVE.Util.CONTEXT_URL}map?`;if(this._view)if(this._modelName){var c=this._view.gather(!1);b+=`_c=${c._c}&_m=${this._modelName}`}else return;else if(this._queryName)b+=`_mod=${this._moduleName}&_q=${this._queryName}&_geo=${this._geometryBinding}`;else return;this._refreshing=!0;var d="";this.loading==="lazy"&&this.webmap&&(c=this.webmap.wrapLatLngBounds(this.webmap.getBounds()))&&(d=c.getNorthEast(),c=c.getSouthWest(),d=`&_ne=POINT(${d.lng} ${d.lat})&_sw=POINT(${c.lng} ${c.lat})`);isc.RPCManager.sendRequest({showPrompt:!0,
evalResult:!0,actionURL:b+d,httpMethod:"GET",callback:(e,f,g)=>{try{SKYVE.Leaflet.scatter(this,f,a,!0)}finally{this._refreshing=!1}}})}},click:function(a){return a.zoomData?(this._selectedLayer=a,`${a.zoomData.infoMarkup}<br/><br/><input type="button" value="Zoom" onclick="${this.ID}.zoom()"/>`):""},zoom:function(){this._zoomed=!0;const a=this.getPageRect();let b=null,c=null;if(this._selectedLayer.getBounds){var d=this._selectedLayer.getBounds(),e=d.getNorthWest();d=d.getSouthEast();b=this.webmap.latLngToContainerPoint(e);
c=this.webmap.latLngToContainerPoint(d)}else e=this._selectedLayer.feature.geometry.coordinates,e=this.webmap.latLngToContainerPoint(L.latLng(e[1],e[0])),b=L.point(e.x-10,e.y-10),c=L.point(e.x+10,e.y+10);isc.BizUtil.getEditView(this._selectedLayer.zoomData.mod,this._selectedLayer.zoomData.doc,f=>{isc.WindowStack.popup([a[0]+Math.max(b.x,0),a[1]+Math.max(b.y,0),Math.min(c.x-b.x,c.x,a[2]),Math.min(c.y-b.y,c.y,a[3])],"Edit",!0,[f]);f.editInstance(this._selectedLayer.zoomData.bizId,null,null);this._selectedLayer.closePopup();
this._selectedLayer=null})}});isc.ClassFactory.defineClass("BizMapPicker","HTMLFlow");isc.BizMapPicker.addClassMethods({v:0,initialise:function(){eval(`${isc.BizMapPicker.id}.build()`)}});
isc.BizMapPicker.addMethods({init:function(a){this.height=this.width="100%";this.styleName="googleMapDivParent";this.ID=`bizMapPicker${isc.BizMapPicker.v++}`;this.contents=`<div id="${this.ID}_map" style="margin:0;padding:0;height:100%">Loading Map...</div>`;this.Super("init",arguments);this._overlays=[];this.field=a.field;this.drawingTools=a.drawingTools;window.L?this.build():(isc.BizMapPicker.id=this.ID,isc.BizMap.loadLeaflet(isc.BizMapPicker.initialise))},setDisabled:function(a){SKYVE.Leaflet.setDisabled(this,
a)},mapIt:function(){const a=this.field.getValue();SKYVE.Leaflet.scatterValue(this,a)},setFieldValue:function(a){this.field.setValueFromPicker(a)},build:function(){if(this.isDrawn()){if(!this.webmap){const a={zoom:SKYVE.Util.mapZoom,center:SKYVE.Leaflet.centre(),editable:!0,fullscreenControl:{pseudoFullscreen:!1},layers:eval(SKYVE.Util.mapLayers)},b=document.getElementById(`${this.ID}_map`);b.innerHTML="";this.webmap=L.map(b,a);SKYVE.Leaflet.drawingTools(this);SKYVE.Leaflet.geoLocator(this);SKYVE.Leaflet.setDisabled(this,
this.field.isDisabled())}SKYVE.Leaflet.clear(this);this.mapIt()}else this.delayCall("build",null,100)}});
