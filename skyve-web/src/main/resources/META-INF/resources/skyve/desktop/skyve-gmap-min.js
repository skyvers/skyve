isc.ClassFactory.defineClass("BizMap","Canvas");
isc.BizMap.addClassMethods({loadingGMap:!1,loadGMap:function(a){this.loadingGMap?setTimeout(()=>this.loadGMap(a),100):window.google?.maps?a():(this.loadingGMap=!0,SKYVE.Util.loadJS(`wicket/wicket.js?v=${SKYVE.Util.v}`,()=>{SKYVE.Util.loadJS(`wicket/wicket-gmap3.js?v=${SKYVE.Util.v}`,()=>{let b="https://maps.googleapis.com/maps/api/js?v=3&libraries=drawing";SKYVE.Util.googleMapsV3ApiKey&&(b+=`&key=${SKYVE.Util.googleMapsV3ApiKey}`);SKYVE.Util.loadJS(b,()=>{this.loadingGMap=!1;a()})})}))},v:0,initialise:function(){eval(`${isc.BizMap.id}.build()`)}});
isc.BizMap.addMethods({init:function(a){this._refreshRequired=!0;this._zoomed=this._refreshing=!1;this.height=this.width="100%";this.styleName="googleMapDivParent";this.ID=`bizMap${isc.BizMap.v++}`;this.redrawOnResize=!1;this.Super("init",arguments);this._objects={};this._intervalId=null},getInnerHTML:function(){return`<div id="${this.ID}_map" style="margin:0;padding:0;height:100%">Loading Map...</div>`},draw:function(){if(window.google?.maps){if(!this.isDrawn())return this.build(),this.Super("draw",
arguments)}else return isc.BizMap.id=this.ID,isc.BizMap.loadGMap(()=>isc.BizMap.initialise()),this.Super("draw",arguments)},setDataSource:function(a){if(window.google?.maps&&this.webmap){if(this._view){this._modelName=a;this._geometryBinding=this._queryName=this._moduleName=null;var b;let c;(b=this._view._grids)[c=a]||(b[c]={});this._view._grids[a][this.getID()]=this}else b=a.indexOf("_"),this._moduleName=a.substring(0,b),this._queryName=a.substring(b+1),this._geometryBinding=this._queryName.split("_").pop(),
this._queryName=this._queryName.split("_")[0],this._modelName=null;this._refresh(!0)}else this.delayCall("setDataSource",arguments,100)},build:function(){if(this.isDrawn()){const a={zoom:this.webmap?.getZoom()||1,center:this.webmap?.getCenter()||new google.maps.LatLng(0,0),mapTypeId:this.webmap?.getMapTypeId()||eval(SKYVE.Util.mapLayers)};this._objects={};this.infoWindow=new google.maps.InfoWindow({content:""});this.webmap=new google.maps.Map(document.getElementById(`${this.ID}_map`),a);this.showRefresh&&
SKYVE.GMap.refreshControls(this);"lazy"===this.loading&&(this.webmap.addListener("zoom_changed",()=>{this._refreshing||this._refresh(!1)}),this.webmap.addListener("dragend",()=>this._refresh(!1)));this._refresh(!0);this._intervalId&&(clearInterval(this._intervalId),this._intervalId=null);0<this.refreshTime&&this._refreshRequired&&(this._intervalId=setInterval(this.rerender.bind(this),1E3*this.refreshTime))}else this.delayCall("build",null,100)},rerender:function(){this._refresh(!1)},resume:function(){this._zoomed=
!1},_refresh:function(a){if(!this._zoomed&&!this._refreshing&&this.isDrawn()&&this.isVisible()){this._refreshing=!0;var b=`${SKYVE.Util.CONTEXT_URL}map?`;if(this._view)if(this._modelName){var c=this._view.gather(!1);b+=`_c=${c._c}&_m=${this._modelName}`}else return;else if(this._queryName)b+=`_mod=${this._moduleName}&_q=${this._queryName}&_geo=${this._geometryBinding}`;else return;c="";if("lazy"===this.loading&&this.webmap?.getBounds()){const d=this.webmap.getBounds(),e=new Wkt.Wkt;e.fromObject(d.getNorthEast());
c=`&_ne=${e.write()}`;e.fromObject(d.getSouthWest());c+=`&_sw=${e.write()}`}isc.RPCManager.sendRequest({showPrompt:!0,evalResult:!0,actionURL:b+c,httpMethod:"GET",callback:(d,e)=>{try{SKYVE.GMap.scatter(this,e,a,!0)}finally{this._refreshing=!1}}})}},click:function(a,b){let c=a.infoMarkup;c+=`<br/><br/><input type="button" value="Zoom" onclick="${this.ID}.zoom(`;if(a.getPosition)b=a.getPosition(),c+=`${b.lat()},${b.lng()},${b.lat()},${b.lng()},'${a.mod}','${a.doc}','${a.bizId}')"/>`,this.infoWindow.open(this.webmap,
a),this.infoWindow.setContent(c);else if(a.getPath){var d=new google.maps.LatLngBounds,e=a.getPath();for(let g=0,k=e.getLength();g<k;g++)d.extend(e.getAt(g));e=d.getNorthEast();d=d.getSouthWest();c+=`${e.lat()},${d.lng()},${d.lat()},${e.lng()},'${a.mod}','${a.doc}','${a.bizId}')"/>`;this.infoWindow.setPosition(b.latLng);this.infoWindow.open(this.webmap);this.infoWindow.setContent(c)}else a.getBounds&&(e=a.getBounds(),d=e.getNorthEast(),e=e.getSouthWest(),c+=`${d.lat()},${e.lng()},${e.lat()},${d.lng()},'${a.mod}','${a.doc}','${a.bizId}')"/>`,
this.infoWindow.setPosition(b.latLng),this.infoWindow.open(this.webmap),this.infoWindow.setContent(c))},zoom:function(a,b,c,d,e,g,k){this._zoomed=!0;const h=Math.pow(2,this.webmap.getZoom());var f=new google.maps.LatLng(this.webmap.getBounds().getNorthEast().lat(),this.webmap.getBounds().getSouthWest().lng());f=this.webmap.getProjection().fromLatLngToPoint(f);a=this.webmap.getProjection().fromLatLngToPoint(new google.maps.LatLng(a,b));c=this.webmap.getProjection().fromLatLngToPoint(new google.maps.LatLng(c,
d));d=this.getPageRect();const l=Math.floor((a.x-f.x)*h)+d[0],m=Math.floor((a.y-f.y)*h)+d[1],p=Math.floor((c.x-f.x)*h)+d[0]-l,q=Math.floor((c.y-f.y)*h)+d[1]-m;isc.BizUtil.getEditView(e,g,n=>{isc.WindowStack.popup([l,m,p,q],"Edit",!0,[n]);n.editInstance(k,null,null);this.infoWindow.close()})}});isc.ClassFactory.defineClass("BizMapPicker","HTMLFlow");isc.BizMapPicker.addClassMethods({v:0,initialise:function(){eval(`${isc.BizMapPicker.id}.build()`)}});
isc.BizMapPicker.addMethods({init:function(a){this.height=this.width="100%";this.styleName="googleMapDivParent";this.ID=`bizMapPicker${isc.BizMapPicker.v++}`;this.contents=`<div id="${this.ID}_map" style="margin:0;padding:0;height:100%">Loading Map...</div>`;this.Super("init",arguments);this._overlays=[];this.field=a.field;this.drawingTools=a.drawingTools;window.google&&window.google.maps?this.build():(isc.BizMapPicker.id=this.ID,isc.BizMap.loadGMap(isc.BizMapPicker.initialise))},setDisabled:function(a){SKYVE.GMap.setDisabled(this,
a)},mapIt:function(){const a=this.field.getValue();SKYVE.GMap.scatterValue(this,a)},setFieldValue:function(a){this.field.setValueFromPicker(a)},build:function(){if(this.isDrawn()){const a={zoom:SKYVE.Util.mapZoom,center:SKYVE.GMap.centre(),mapTypeId:eval(SKYVE.Util.mapLayers),mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU}};this.webmap=new google.maps.Map(document.getElementById(`${this.ID}_map`),a);SKYVE.GMap.drawingTools(this);SKYVE.GMap.geoLocator(this);SKYVE.GMap.setDisabled(this,
this.field.isDisabled());SKYVE.GMap.clear(this);this.delayCall("mapIt",null,100)}else this.delayCall("build",null,100)}});
