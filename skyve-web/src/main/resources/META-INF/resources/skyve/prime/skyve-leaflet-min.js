SKYVE.BizMap=function(){var g={},e=function(a,c){if(!a._refreshing){a._refreshing=!0;var b="";if("lazy"===a.loading){var h=a.webmap.wrapLatLngBounds(a.webmap.getBounds());if(h){var f=h.getNorthEast();b="&_ne=POINT("+f.lng+" "+f.lat+")";f=h.getSouthWest();b+="&_sw=POINT("+f.lng+" "+f.lat+")"}}$.get(a.url+b,function(d){try{SKYVE.Leaflet.scatter(a,d,c,!0)}finally{a._refreshing=!1}})}};return{create:function(a){var c={zoom:1,center:[0,0],fullscreenControl:{pseudoFullscreen:!1},layers:eval(SKYVE.Util.mapLayers)},
b=g[a.elementId];b?(b.webmap&&(c.zoom=b.webmap.getZoom(),c.center=b.webmap.getCenter()),b._intervalId&&(clearInterval(b._intervalId),b._intervalId=null)):(b={_objects:null,refreshTime:a.refreshTime,loading:a.loading,_refreshRequired:!0,_refreshing:!1,_intervalId:null,click:function(k){return SKYVE.BizMap.click(this,k)},rerender:function(){e(this,!1)},moduleName:a.moduleName,queryName:a.queryName,geometryBinding:a.geometryBinding,documentName:a.documentName,modelName:a.modelName},g[a.elementId]=b);
var h=!1;if(b.documentName){var f=b.moduleName+"_"+b.documentName+"_"+b.modelName,d=sessionStorage.getItem(f);d&&(h=!0,d=JSON.parse(d),c.center=d.centre,c.zoom=d.zoom,sessionStorage.removeItem(f))}else if(f=b.moduleName+"_"+b.queryName+"_"+b.geometryBinding,d=sessionStorage.getItem(f))h=!0,d=JSON.parse(d),c.center=d.centre,c.zoom=d.zoom,sessionStorage.removeItem(f);b._objects={};b.webmap=L.map(SKYVE.PF.getByIdEndsWith(a.elementId)[0],c);a.showRefresh&&SKYVE.Leaflet.refreshControls(b);"lazy"===a.loading&&
(b.webmap.on("zoomend",function(k){b._refreshing||e(b,!1)}),b.webmap.on("moveend",function(k){e(b,!1)}));c=SKYVE.Util.CONTEXT_URL+"map?";a.modelName?c+="_c="+a._c+"&_m="+a.modelName:a.queryName&&(c+="_mod="+a.moduleName+"&_q="+a.queryName+"&_geo="+a.geometryBinding);b.url=c;e(b,!h);0<b.refreshTime&&b._refreshRequired&&(b._intervalId=setInterval(b.rerender.bind(b),1E3*b.refreshTime));return b},get:function(a){return g[a]},click:function(a,c){a.documentName?sessionStorage.setItem(a.moduleName+"_"+a.documentName+
"_"+a.modelName,'{"centre":'+JSON.stringify(a.webmap.getCenter())+',"zoom":'+a.webmap.getZoom()+"}"):sessionStorage.setItem(a.moduleName+"_"+a.queryName+"_"+a.geometryBinding,'{"centre":'+JSON.stringify(a.webmap.getCenter())+',"zoom":'+a.webmap.getZoom()+"}");a=c.zoomData.infoMarkup;a+='<br/><br/><input type="button" value="Zoom" onclick="window.location=\''+SKYVE.Util.CONTEXT_URL;return a+="?m="+c.zoomData.mod+"&d="+c.zoomData.doc+"&i="+c.zoomData.bizId+"'\"/>"},resizeAll:function(){setTimeout(function(){for(var a in g)g[a].webmap.invalidateSize(!1)},
0)}}}();
SKYVE.BizMapPicker=function(){var g={};return{create:function(e){var a={zoom:SKYVE.Util.mapZoom,center:SKYVE.Leaflet.centre(),editable:!0,fullscreenControl:{pseudoFullscreen:!1},layers:eval(SKYVE.Util.mapLayers)},c=g[e.elementId];c?c.webmap&&(a.zoom=c.webmap.getZoom(),a.center=c.webmap.getCenter()):(c={_overlays:[],drawingTools:e.drawingTools,setFieldValue:function(f){var d=SKYVE.PF.getTextElement(b+"_value");d.val(f);d.change()}},g[e.elementId]=c);var b=SKYVE.PF.getByIdEndsWith(e.elementId).attr("id"),h=
document.getElementById(b);1>=h.childNodes.length&&(c.webmap=L.map(h,a),e.disabled||(SKYVE.Leaflet.drawingTools(c),SKYVE.Leaflet.geoLocator(c)));SKYVE.Leaflet.clear(c);e=SKYVE.PF.getTextElement(b+"_value");e.attr("readonly",!0);SKYVE.Leaflet.scatterValue(c,e.val())},resizeAll:function(){setTimeout(function(){for(var e in g)g[e].webmap.invalidateSize(!1)},0)}}}();
